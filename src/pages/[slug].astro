---
import Container from '@components/Container.astro';
import Hero from '@components/Hero.astro';
import { readItems, readSingleton } from '@directus/sdk';
import getPageContent from '@utils/getPageContent';
import { injectDataIntoContent } from 'directus-extension-flexible-editor/content';
import directus from '../../lib/directus';

import type { TipTapNode } from '@components/TipTapRender';
import BodyContent from '@components/TipTapRender/BodyContent';
import { TipTapRender } from '@components/TipTapRender/TipTapRender';
import BaseLayout from '@layouts/BaseLayout.astro';
import getPageHero from '@utils/getPageHero';
import getPageSeo from '@utils/getPageSeo';

const global = await directus.request(readSingleton('General'));

export async function getStaticPaths() {
  const pages = await directus.request(
    readItems('pages', {
      fields: [
        'id',
        'title',
        'slug',
        'body_content',
        'editor_nodes.id',
        'editor_nodes.collection',
        { editor_nodes: ['*.*.*.*.*.*'] },
      ],
    })
  );

  const cleanPages = pages.map((page) => {
    injectDataIntoContent(page.editor_nodes, page.body_content);

    return page;
  });

  return cleanPages.map((page) => ({
    params: { slug: page.slug },
    props: page,
  }));


}

const page = Astro.props;

const pageHero = await getPageHero(page.slug);
const pageSeo = await getPageSeo(page.slug);

---

<BaseLayout
  title={`${pageHero.title} | ${global.site_name} - ${global.site_subheader}`}
  seo={pageSeo}
>
  <Hero pageHero={pageHero} />
  {
    !!page.body_content && (
      <div>
        <TipTapRender handlers={BodyContent} node={page.body_content as TipTapNode} />
      </div>
    )
  }
  <Container />
</BaseLayout>
